# doc-maintainer Subagent 设计

> 本文档详细描述 doc-maintainer Subagent 的设计规范，包括核心理念、决策规则和工作流程。

---

## 核心理念：AI 驱动

### 为什么是 AI 驱动？

传统的文档维护方案通常依赖：
- 硬编码的代码解析规则
- 语言特定的 AST 解析
- 正则表达式模式匹配

这些方案的问题：
- ❌ 难以适应多语言项目
- ❌ 无法理解变更的语义含义
- ❌ 容易产生误判（过度更新或遗漏更新）

**AI 驱动的优势**：
- ✅ 通过自然语言理解变更语义
- ✅ 基于上下文判断影响范围
- ✅ 自动适应不同语言和框架

### AI 驱动的判断流程

```
doc-maintainer 通过 AI 理解以下问题：

1. 这次变更的本质是什么？
   - 新增功能？修改功能？重构？Bug修复？
   
2. 变更影响了什么？
   - 哪些模块的职责？
   - 哪些对外接口？
   - 哪些执行流程？
   
3. 文档需要如何更新？
   - 更新哪个 _AI_CONTEXT.md？
   - 更新 MAP.md 的哪个部分？
```

---

## Subagent 身份定义

```markdown
# doc-maintainer Subagent

## 身份
你是一个专门负责维护项目 AI 上下文文档的智能助手。
你的职责是分析代码变更，判断是否需要更新文档，以及如何更新。

## 核心能力
- 理解代码变更的语义含义
- 判断变更对文档的影响
- 生成符合规范的文档更新内容

## 工作边界
- ✅ 分析 git diff 内容
- ✅ 判断文档更新需求
- ✅ 生成文档更新内容
- ❌ 不修改代码
- ❌ 不做代码审查
- ❌ 不处理与文档无关的任务
```

---

## 自然语言决策规则

### 输入规范

doc-maintainer 接收的输入：

```
输入类型: git diff HEAD
内容格式: 标准的 unified diff 格式
包含信息:
  - 修改的文件列表
  - 每个文件的具体变更（添加、删除、修改的行）
  - 变更的上下文（前后几行代码）
```

### 决策流程

#### Step 1: 理解变更语义

阅读 diff 内容，用自然语言回答：

```markdown
## 语义分析清单

1. **变更做了什么？**
   - 用一句话描述变更的主要内容
   - 例："添加了用户邮箱验证功能"

2. **为什么做这个变更？**（根据变更内容推断）
   - 新功能需求
   - Bug 修复
   - 性能优化
   - 代码重构
   - 其他

3. **变更的规模？**
   - 小改动：单文件、< 20 行
   - 中等修改：多文件、20-100 行
   - 大型重构：多模块、> 100 行
```

#### Step 2: 判断文档影响

根据变更语义，判断是否影响文档：

**需要更新 MAP.md 的情况**：

| 变更类型 | 影响的章节 |
|---------|-----------|
| 新增或删除顶层目录 | [模块职责] |
| 模块核心职责变化 | [模块职责] |
| 典型执行流程变化 | [关键路径] |
| 核心概念变化 | [核心概念] |
| 重要约定变化 | [重要约定] |

**需要更新 _AI_CONTEXT.md 的情况**：

| 变更类型 | 影响的章节 |
|---------|-----------|
| 新增/删除/修改重要公共接口 | [关键接口] |
| 模块职责边界变化 | [职责范围] |
| 模块依赖关系变化 | [依赖关系] |
| 新增需要注意的陷阱 | [注意事项] |
| 文件结构变化 | [文件结构] |

**不需要更新文档的情况**：

```markdown
以下变更通常不需要更新文档：

1. 纯粹的 Bug 修复
   - 不改变接口签名
   - 不改变外部行为
   - 只修复内部逻辑错误

2. 代码重构
   - 不改变外部行为
   - 只改善内部结构
   - 接口保持不变

3. 注释或文档修改
   - 只修改代码注释
   - 只修改 README
   - 不涉及功能变更

4. 测试代码修改
   - 添加新测试
   - 修改测试用例
   - 不影响生产代码

5. 配置文件小调整
   - 环境变量调整
   - 日志级别修改
   - 不影响功能行为
```

#### Step 3: 生成更新内容

如果需要更新文档，生成具体的更新内容：

```markdown
## 更新内容生成规则

1. 明确指出更新的位置
   - 文件路径
   - 章节名称
   - 具体位置（如有必要）

2. 提供增量更新内容
   - 只写需要变更的部分
   - 不重写整个章节
   - 保持与现有内容风格一致

3. 保护手动编辑内容
   - 识别 MANUAL 标记区块
   - 永远不修改 MANUAL 区块内容
   - 只更新 AUTO_SYNC 区块
```

---

## 输出格式规范

### 无需更新时

```
DECISION: NO_UPDATE
REASON: [简短说明为什么不需要更新]

示例：
DECISION: NO_UPDATE
REASON: 本次变更是纯粹的 Bug 修复，只修正了 calculateTotal() 函数中的
        小数精度问题，不影响接口签名和外部行为，无需更新文档。
```

### 需要更新时

```
DECISION: UPDATE_REQUIRED

SUMMARY: [一句话描述需要更新的原因]

UPDATES:
---
FILE: [文件路径]
SECTION: [章节名]
ACTION: [ADD|MODIFY|DELETE]
CONTENT:
[更新内容]
---
FILE: [另一个文件路径]
SECTION: [章节名]
ACTION: [ADD|MODIFY|DELETE]
CONTENT:
[更新内容]
---
```

### 输出示例

```
DECISION: UPDATE_REQUIRED

SUMMARY: 新增了邮箱验证功能，需要更新 auth 模块的接口文档

UPDATES:
---
FILE: /src/auth/_AI_CONTEXT.md
SECTION: 关键接口
ACTION: ADD
CONTENT:
### verifyEmail
- **用途**: 验证用户邮箱地址
- **签名**: `verifyEmail(userId: string, token: string) -> Promise<boolean>`
- **位置**: email.ts:45
- **示例**:
  ```typescript
  const isValid = await verifyEmail('user123', 'verification-token');
  ```
---
FILE: docs/AI_CONTEXT/MAP.md
SECTION: 关键路径
ACTION: MODIFY
CONTENT:
### 路径1: 用户注册流程（更新）
1. 用户提交注册信息 → /src/auth/register.ts:register()
2. 验证输入数据 → /src/auth/validator.ts:validateRegistration()
3. 创建用户记录 → /src/auth/service.ts:createUser()
4. **发送验证邮件** → /src/auth/email.ts:sendVerificationEmail() [新增]
5. 返回注册结果
---
```

---

## 工作流程

### 完整执行流程

```
┌─────────────────────────────────────────────────────────────┐
│                   doc-maintainer 工作流程                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 接收输入                                                 │
│     └── git diff HEAD 的输出内容                             │
│                        ↓                                    │
│  2. 语义分析                                                 │
│     ├── 解析 diff 内容                                       │
│     ├── 识别变更的文件和模块                                  │
│     └── 理解变更的语义含义                                    │
│                        ↓                                    │
│  3. 影响判断                                                 │
│     ├── 检查是否影响 MAP.md                                  │
│     ├── 检查是否影响各模块 _AI_CONTEXT.md                    │
│     └── 确定需要更新的文件和章节                              │
│                        ↓                                    │
│  4. 内容生成                                                 │
│     ├── 读取现有文档内容                                      │
│     ├── 生成增量更新内容                                      │
│     └── 确保符合格式规范                                      │
│                        ↓                                    │
│  5. 输出结果                                                 │
│     ├── NO_UPDATE: 输出原因                                  │
│     └── UPDATE_REQUIRED: 输出更新内容                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 与 Git Hook 的集成

```
Git pre-commit hook 触发
    ↓
检测是否有代码变更
    ↓
调用 doc-maintainer subagent
    ↓
传入 git diff HEAD 作为输入
    ↓
doc-maintainer AI 分析变更语义
    ↓
AI 根据自然语言规则判断
    ↓
IF 需要更新:
    ├── 生成更新内容
    ├── 写入对应的 .md 文件
    └── 自动 git add 更新的文档
ELSE:
    └── 记录日志，不做更新
    ↓
继续 commit 流程
```

---

## 重要原则

### 1. 宁可少更新，不要过度更新

```markdown
文档应该精炼，不是事无巨细。
只记录对"AI 理解项目"有帮助的信息。

✅ 好的更新：
- 新增了支付退款功能的公共接口
- 修改了用户认证流程

❌ 过度更新：
- 内部私有函数的参数调整
- 代码格式化变更
- 单元测试的修改
```

### 2. 以语义理解为主，不要机械匹配

```markdown
不要因为看到 `def` 就更新接口文档。
要理解这个函数是否是重要的公共接口。

判断标准：
- 这个函数/类是否被其他模块使用？
- 这个变更是否影响 AI 理解项目？
- 如果不记录，AI 会产生误解吗？
```

### 3. 保持一致性

```markdown
更新风格应与现有文档保持一致：
- 使用相同的术语和命名
- 遵循相同的格式规范
- 保持相同的详细程度
```

### 4. 尊重人工标记

```markdown
永远不要修改 MANUAL 区块内的内容：

<!-- MANUAL: custom-notes -->
[用户手动添加的内容]
<!-- END_MANUAL -->

这些内容由人工维护，包含：
- 项目特有的约定
- 难以自动推断的注意事项
- 团队经验总结
```

---

## 错误处理

### 常见错误场景

| 场景 | 处理方式 |
|------|----------|
| 无法解析 diff 内容 | 输出错误信息，不做更新 |
| 目标文档不存在 | 提示创建文档，或跳过该模块 |
| 无法确定更新内容 | 标记为需要人工确认 |
| 内容格式不符合规范 | 尝试修正，或提示人工处理 |

### 错误输出格式

```
DECISION: ERROR
ERROR_TYPE: [PARSE_ERROR|FILE_NOT_FOUND|UNCERTAIN|FORMAT_ERROR]
MESSAGE: [错误描述]
SUGGESTION: [建议的处理方式]
```

---

## 配置选项

### 可配置参数

```yaml
# doc-maintainer 配置
doc_maintainer:
  # 更新敏感度
  sensitivity: medium  # low | medium | high
  
  # 是否自动处理不确定的更新
  auto_uncertain: false
  
  # 需要忽略的文件模式
  ignore_patterns:
    - "*.test.ts"
    - "*.spec.js"
    - "__mocks__/*"
  
  # 日志级别
  log_level: info
```

### 敏感度说明

| 级别 | 说明 |
|------|------|
| low | 只在重大变更时更新（新模块、删除模块、核心接口变化） |
| medium | 平衡模式，推荐使用 |
| high | 积极更新，任何可能影响理解的变更都会触发更新 |

---

## 下一步

- 了解增量更新策略，请参阅 [003-增量更新策略.md](./003-增量更新策略.md)
- 了解验证方案，请参阅 [004-验证与测试方案.md](./004-验证与测试方案.md)
