# 初始化流程说明

> 本文档详细说明如何从零开始为项目建立 AI 上下文框架。

---

## 初始化概览

```
┌─────────────────────────────────────────────────────────────┐
│                    框架初始化完整流程                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: 环境准备                                           │
│  ├── 确认项目满足前置条件                                      │
│  └── 准备必要的工具和权限                                      │
│                        ↓                                    │
│  Phase 2: 核心文件创建（按顺序）                               │
│  ├── Step 1: 创建 docs/AI_CONTEXT/ 目录                     │
│  ├── Step 2: 创建 _RULES.md（AI 行为协议）                   │
│  ├── Step 3: 创建 MAP.md（项目导航）                         │
│  └── Step 4: 创建模块 _AI_CONTEXT.md                        │
│                        ↓                                    │
│  Phase 3: 内容填充                                           │
│  ├── AI 辅助生成初始内容                                      │
│  └── 人工验证和补充                                           │
│                        ↓                                    │
│  Phase 4: 自动化配置                                         │
│  ├── 安装 Git Hook                                          │
│  └── 配置 doc-maintainer                                    │
│                        ↓                                    │
│  Phase 5: 验证与测试                                         │
│  ├── 功能验证                                                │
│  └── AI 理解测试                                             │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Phase 1: 环境准备

### 前置条件检查

```markdown
## 项目前置条件

### 必须满足
- [ ] 项目使用 Git 进行版本控制
- [ ] 项目有明确的目录结构（不是单文件项目）
- [ ] 有至少一个人了解项目的整体架构

### 建议满足
- [ ] 项目已有基本的开发文档或注释
- [ ] 项目已进入相对稳定的开发阶段
- [ ] 团队成员了解 Markdown 语法

### 不适用的场景
- ❌ 单文件脚本项目
- ❌ 纯配置/数据项目
- ❌ 一次性或临时项目
```

### 权限检查

```bash
# 检查 Git 仓库
git status
# 应该显示当前在一个 Git 仓库中

# 检查写入权限
touch docs/test_write_permission.txt && rm docs/test_write_permission.txt
# 应该能正常创建和删除文件

# 检查 hooks 目录
ls -la .git/hooks/
# 应该存在 hooks 目录
```

---

## Phase 2: 基于 Subagent 的智能初始化

> 核心思路：利用 AI Subagent 在各个目录层级进行智能分析，结合预定义的生成规范（Skill），自动创建和填充 `_AI_CONTEXT.md` 文件。

### 初始化架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    Subagent 智能初始化架构                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              预定义生成规范 (Skills / Rules)                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ 文档结构模板 │  │ 内容生成规则 │  │ 质量检查标准    │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   分层级 Subagent 调用                      │  │
│  │                                                            │  │
│  │   Level 1: 项目根目录分析                                   │  │
│  │   ├── 扫描项目整体结构                                      │  │
│  │   ├── 识别主要模块和关键配置                                │  │
│  │   └── 生成 docs/AI_CONTEXT/MAP.md                          │  │
│  │                    ↓                                        │  │
│  │   Level 2: 模块层分析 (src/, lib/, docs/ 等)               │  │
│  │   ├── 为每个重要目录调用专用 Subagent                       │  │
│  │   ├── 分析目录内的文件结构和代码逻辑                        │  │
│  │   └── 生成 /<模块>/_AI_CONTEXT.md                          │  │
│  │                    ↓                                        │  │
│  │   Level 3: 文件层分析 (关键代码文件)                        │  │
│  │   ├── 对重要文件进行深度分析                                │  │
│  │   ├── 提取函数签名、类定义和注释                            │  │
│  │   └── 补充到对应模块的上下文中                              │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                    交叉验证和整合                            │  │
│  │  ├── 上层 Subagent 验证下层内容一致性                       │  │
│  │  ├── 建立模块间的关联关系描述                               │  │
│  │  └── 确保整个项目的上下文连贯性                             │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 分层级 Subagent 调用

### Level 1: 项目根目录分析

**Subagent 名称**: `context-initializer-root`

**输入**: 项目根目录路径
**输出**: `docs/AI_CONTEXT/MAP.md` + `docs/AI_CONTEXT/_RULES.md`

**执行流程**:

```
用户触发: "初始化项目的 AI 上下文框架"
    ↓
Subagent 执行:
    ↓
1. 扫描项目整体结构
   ├── 列出所有顶层目录
   ├── 识别配置文件 (package.json, setup.py, go.mod, Cargo.toml 等)
   ├── 读取 README.md（如存在）
   └── 统计项目规模（目录数、文件数）
    ↓
2. 智能分析
   ├── 推断项目类型和技术栈
   ├── 识别入口点和主要模块
   ├── 分析目录命名模式
   └── 提取项目描述和核心价值
    ↓
3. 生成项目级文档
   ├── 创建 docs/AI_CONTEXT/ 目录
   ├── 生成 _RULES.md（使用标准模板）
   ├── 生成 MAP.md 初稿
   │   ├── [项目概览] - 基于分析结果填充
   │   ├── [模块职责] - 列出识别到的模块
   │   ├── [关键路径] - 标记为待分析
   │   └── [核心概念] - 标记为待分析
   └── 输出需要进一步分析的模块列表
    ↓
4. 触发下一层分析
   └── 为每个重要模块调用 Level 2 Subagent
```

---

### Level 2: 模块层分析

**Subagent 名称**: `context-initializer-module`

**输入**: 模块目录路径 + 上层分析结果
**输出**: `/<模块>/_AI_CONTEXT.md`

**执行流程**:

```
接收上层调用: analyze_module("/src/payment")
    ↓
Subagent 执行:
    ↓
1. 扫描模块结构
   ├── 列出目录内所有文件
   ├── 识别主要文件和入口文件
   ├── 分析文件命名模式
   └── 统计代码行数
    ↓
2. 深度代码分析
   ├── 解析 import/require 语句 → 提取依赖关系
   ├── 识别 exported/public 接口
   ├── 提取类定义和函数签名
   └── 读取现有注释和文档字符串
    ↓
3. 智能推断
   ├── 基于文件名和代码内容推断模块职责
   ├── 基于调用关系推断关键接口
   ├── 基于导出判断对外暴露的能力
   └── 标记需要人工验证的推断 (⚠️)
    ↓
4. 生成模块级文档
   └── 创建 /<模块>/_AI_CONTEXT.md
       ├── [职责范围] - 填充推断结果
       ├── [文件结构] - 自动生成目录树
       ├── [关键接口] - 填充提取的接口
       ├── [依赖关系] - 填充分析结果
       └── [注意事项] - 保留为 MANUAL 区块
    ↓
5. 返回分析结果
   └── 供上层 Subagent 更新 MAP.md
```

---

### Level 3: 文件层分析（可选深度）

**触发条件**: 
- 模块复杂度高（文件数 > 10 或代码行数 > 1000）
- 用户明确要求深度分析

**Subagent 名称**: `context-initializer-file`

**输入**: 关键文件路径
**输出**: 补充到模块 _AI_CONTEXT.md 的详细接口文档

**执行流程**:

```
接收调用: analyze_file("/src/payment/processor.ts")
    ↓
1. 深度解析文件
   ├── 解析 AST（抽象语法树）
   ├── 提取所有函数定义和签名
   ├── 提取所有类定义和方法
   ├── 提取注释和文档字符串
   └── 分析函数调用关系
    ↓
2. 生成详细文档
   ├── 为每个公共函数生成接口文档
   ├── 为每个类生成类图描述
   └── 生成调用流程图
    ↓
3. 补充到模块文档
   └── 更新 /<模块>/_AI_CONTEXT.md [关键接口]
```

---

## 交叉验证和整合

### 一致性验证

```
Level 2 分析完成后:
    ↓
1. 收集所有模块的分析结果
    ↓
2. 交叉验证
   ├── 检查依赖关系是否双向一致
   │   例: /auth 说被 /payment 依赖
   │        → 验证 /payment 说依赖 /auth
   │
   ├── 检查术语定义一致性
   │   例: "Transaction" 在所有模块中含义相同
   │
   └── 检查路径引用有效性
       例: MAP.md 中引用的 _AI_CONTEXT.md 都存在
    ↓
3. 整合到 MAP.md
   ├── 更新 [模块职责] - 填充所有模块描述
   ├── 更新 [关键路径] - 基于模块间调用关系生成
   ├── 更新 [核心概念] - 汇总各模块的领域概念
   └── 标记需要人工验证的内容 (⚠️)
    ↓
4. 输出验证报告
   └── 列出发现的不一致和待确认项
```

---

## 智能初始化 Subagent 调用示例

### 触发方式

用户可以通过以下方式触发初始化：

```markdown
# 方式 1: 直接对话
用户: "帮我初始化这个项目的 AI 上下文框架"

# 方式 2: 使用 Skill
用户: "使用 ai-context-generator skill 初始化项目"

# 方式 3: 命令行（如果集成到 CLI）
$ ai-context init
```

### Subagent 调用链

```
用户触发初始化
    ↓
AI 主体识别意图，调用 context-initializer-root
    ↓
context-initializer-root 执行:
    ├── 扫描项目结构
    ├── 生成 docs/AI_CONTEXT/_RULES.md
    ├── 生成 docs/AI_CONTEXT/MAP.md (初稿)
    └── 识别需要分析的模块列表: [/src/auth, /src/payment, /src/order, ...]
    ↓
对每个模块，调用 context-initializer-module
    ├── context-initializer-module("/src/auth")
    │   └── 生成 /src/auth/_AI_CONTEXT.md
    ├── context-initializer-module("/src/payment")
    │   └── 生成 /src/payment/_AI_CONTEXT.md
    └── ... (并行执行)
    ↓
所有模块分析完成后，执行交叉验证
    ├── 检查一致性
    ├── 整合 MAP.md
    └── 生成验证报告
    ↓
输出给用户:
    "✅ AI 上下文框架初始化完成！
     
     已生成文件:
     - docs/AI_CONTEXT/_RULES.md
     - docs/AI_CONTEXT/MAP.md
     - /src/auth/_AI_CONTEXT.md
     - /src/payment/_AI_CONTEXT.md
     - /src/order/_AI_CONTEXT.md
     - ...
     
     ⚠️ 以下内容需要人工验证:
     - MAP.md [重要约定] 部分为空，建议补充
     - /src/payment/_AI_CONTEXT.md [注意事项] 部分为空，建议补充
     
     建议下一步:
     1. 快速浏览 MAP.md 确认模块职责描述准确
     2. 为核心模块补充 [注意事项]
     3. 运行一次 AI 理解测试验证效果"
```

---

## 最佳实践建议

### 初始化阶段

1. **先完成核心文档，再逐步完善**
   ```
   第一天：完成 _RULES.md + MAP.md 骨架
   第一周：完成 3-5 个核心模块的 _AI_CONTEXT.md
   持续：随开发逐步补充其他模块
   ```

2. **让了解项目的人参与验证**
   - AI 生成的内容需要人工验证
   - 特别是 [职责范围] 和 [关键路径]

3. **不要追求完美**
   - 初始内容 70% 准确即可
   - 在使用中逐步修正和完善

### 内容编写

1. **职责描述要聚焦**
   - ✅ "处理用户认证和会话管理"
   - ❌ "包含各种和用户登录相关的代码"

2. **关键接口要有示例**
   - 示例代码比文字描述更清晰
   - 保持示例简洁、可运行

3. **善用 MANUAL 标记**
   - 对于 AI 难以准确理解的约定
   - 对于团队特有的"潜规则"

### 维护阶段

1. **定期检查文档同步**
   ```bash
   # 每周检查命令
   git log --oneline --since="1 week ago" -- "*.py" "*.js" "*.ts" | head -20
   # 对照检查相关的 _AI_CONTEXT.md 是否需要更新
   ```

2. **重大重构后手动验证**
   - 自动维护可能无法完全捕获大型重构
   - 重构后花 10 分钟检查文档

3. **新成员入职测试**
   - 让新成员通过 AI 理解项目
   - 记录 AI 回答不准确的地方
   - 用于改进文档

---

## 常见问题解答

### Q: 初始化需要多长时间？

| 项目规模 | 预计时间 |
|----------|----------|
| 小型项目（< 10 个文件） | 30 分钟 |
| 中型项目（10-50 个文件） | 1-2 小时 |
| 大型项目（> 50 个文件） | 2-4 小时 |

### Q: 哪些目录需要创建 _AI_CONTEXT.md？

**需要创建**:
- 核心业务逻辑目录
- 被多个模块依赖的基础设施目录
- 包含复杂逻辑的目录
- 有特殊约定的目录

**不需要创建**:
- 纯配置文件目录
- 静态资源目录
- 测试数据目录
- 第三方代码目录

### Q: 如何处理已有的 README.md？

两种策略：
1. **共存**：README 面向人类，_AI_CONTEXT.md 面向 AI，内容可以有重叠
2. **引用**：在 _AI_CONTEXT.md 中引用 README 的某些章节，避免重复

### Q: 多人协作时如何避免冲突？

1. 使用 AUTO_SYNC 标记让系统自动管理
2. MANUAL 区域的修改应该先沟通
3. 将 _AI_CONTEXT.md 纳入 Code Review

---

## 下一步

- 了解 [Git Hook 机制](../003-维护框架/001-Git-Hook机制.md)
- 了解 [doc-maintainer 设计](../003-维护框架/002-doc-maintainer设计.md)
