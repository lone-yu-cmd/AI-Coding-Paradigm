# 文档层级设计

> 本文档详细说明 AI Context 框架的三层文档结构设计。

---

## 三层文档架构

```
┌─────────────────────────────────────────────────────┐
│ Layer 1: docs/AI_CONTEXT/_RULES.md - AI 行为规则层   │
│ - 定义 AI 何时读取文档                                 │
│ - 定义 AI 如何理解项目                                 │
│ - 定义遇到问题时的处理策略                              │
│ - 适用于任何 AI 编程助手                               │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ Layer 2: docs/AI_CONTEXT/MAP.md - 导航索引层          │
│ - 项目概览（一句话描述 + 核心价值）                     │
│ - 模块职责（每个目录负责什么 + _AI_CONTEXT.md 路径）    │
│ - 关键路径（典型场景的执行流程）                        │
│ - 核心概念（领域模型）                                 │
└─────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ Layer 3: /<模块目录>/_AI_CONTEXT.md - 模块详情层       │
│ - 模块职责范围                                        │
│ - 文件结构说明                                        │
│ - 关键接口文档                                        │
│ - 依赖关系图                                          │
│ - 使用示例和注意事项                                   │
└─────────────────────────────────────────────────────┘
```

---

## Layer 1: _RULES.md 模板

### 职责说明

定义 AI 在项目中的行为规范，适用于**任何 AI 编程助手**：
- 新对话启动流程
- 任务驱动的文档加载策略
- 文档异常处理
- 文档更新触发规则

### 完整模板

```markdown
# AI Context Rules

> 本文档定义 AI 编程助手在本项目中的行为规范。
> 适用于：Claude、GPT、Gemini、Copilot 等任何 AI 助手。
> 
> ⚠️ 本文件是 AI 的"工作手册"，请勿随意修改。

```
---

## 新对话启动流程

当开始一个新对话时，AI 必须按以下顺序执行：

### Step 1: 读取导航文件（强制）
```
READ: docs/AI_CONTEXT/MAP.md

```

### Step 2: 快速理解项目（2分钟内）
请在"工作记忆"中记住以下信息：
- 项目一句话描述是什么？
- 有哪些主要模块？各自负责什么？
- 有哪些核心概念？
- 有哪些重要约定必须遵守？

### Step 3: 建立心智模型
在开始任何任务前，确保你能回答：
- 要做 X 功能 → 应该看 Y 模块
- Y 模块位于 Z 目录
- Y 模块的详细文档是 Z/_AI_CONTEXT.md

---

## 任务驱动的文档加载策略

根据用户任务类型，按需加载相关文档：

| 任务类型 | 加载策略 |
|---------|---------|
| 理解现有功能 | MAP.md → 定位模块 → 模块/_AI_CONTEXT.md → 代码文件 |
| 修改现有代码 | MAP.md → 模块/_AI_CONTEXT.md（检查依赖和注意事项）→ 代码文件 |
| 添加新功能 | MAP.md → 判断目标模块 → 模块/_AI_CONTEXT.md（扩展指南）→ 现有代码 |
| 修复 Bug | MAP.md [关键路径] → 相关模块/_AI_CONTEXT.md → 代码文件 |

---

## 文档异常处理

### 文档不存在
```
IF docs/AI_CONTEXT/MAP.md 不存在:
    提示用户: "项目尚未初始化 AI 上下文，建议运行初始化"
    询问: "是否需要我帮助初始化？"
```

### 文档内容与代码不符
```
IF 发现文档描述与实际代码不一致:
    1. 以代码为准完成当前任务
    2. 完成任务后提示用户文档可能过时
    3. 如果用户确认，更新文档
```

### 模块文档缺失
```
IF MAP.md 中某个模块没有对应的 _AI_CONTEXT.md:
    1. 直接阅读该模块的代码
    2. 完成任务
    3. (可选) 提示用户是否需要为该模块生成文档
```

---

## 阅读效率优化

### 分层阅读策略
```
Layer 0: MAP.md [快速定位]              - 必读，<30秒
Layer 1: MAP.md [项目概览] + [模块职责]  - 了解全局，<2分钟
Layer 2: MAP.md [关键路径] + [核心概念]  - 理解运作，<5分钟
Layer 3: 相关 /<模块>/_AI_CONTEXT.md    - 深入细节，按需
Layer 4: 具体代码文件                    - 精确理解，按需
```

### 避免过度阅读
- ❌ 不要一次性阅读所有 _AI_CONTEXT.md
- ✅ 根据任务类型，只读取相关模块的文档
- ❌ 不要阅读代码后再读文档
- ✅ 先读文档建立心智模型，再读代码验证
- 
---

## Layer 2: MAP.md 模板

### 职责说明

作为项目的"入口文档"，提供：
- 快速定位：要做 X，应该看哪个模块
- 职责映射：每个模块负责什么
- 执行路径：典型场景如何运行
- 概念词典：核心领域概念

### 完整模板

```markdown
# Project Map

## 快速定位

### 我想理解项目整体
→ 阅读本文档的 [项目概览] 部分

### 我想修改某个功能
→ 在 [模块职责] 中找到负责该功能的目录
→ 阅读对应目录下的 _AI_CONTEXT.md

### 我想添加新功能
→ 在 [模块职责] 中判断应该放在哪个模块
→ 阅读该模块的 _AI_CONTEXT.md 了解约定

### 我想理解数据流
→ 阅读 [关键路径] 部分

---

## 项目概览

**一句话描述**: [30字以内，说明项目是什么]

**核心价值**: [解决什么问题，为谁解决]

**主要技术栈**: [语言、框架、关键工具]

**项目规模**:
- 主要目录数: ~N
- 核心模块数: ~N

---

## 模块职责

### /src/auth
**职责**: 用户认证与会话管理
**关键能力**:
- 用户登录/注销
- Session 管理
- Token 验证
**详细文档**: [_AI_CONTEXT.md](/src/auth/_AI_CONTEXT.md)

### /src/payment
**职责**: 支付处理
**关键能力**:
- 订单支付
- 账单管理
- 退款处理
**详细文档**: [_AI_CONTEXT.md](/src/payment/_AI_CONTEXT.md)

[... 更多模块]

---

## 关键路径

### 路径1: 用户登录流程
1. [用户提交凭证] → src/auth/login.py:authenticate()
2. [验证密码] → src/auth/password.py:verify()
3. [创建会话] → src/auth/session.py:create_session()
4. [返回 Token]

### 路径2: 支付流程
[类似描述...]

---

## 核心概念

- **User**: 系统用户实体 - src/models/user.py
- **Session**: 用户会话 - src/auth/session.py
- **Order**: 订单实体 - src/models/order.py

**概念关系**:
- User 拥有多个 Session
- User 可以创建多个 Order

---

## 重要约定

### 架构约定
- [约定1]
- [约定2]

### 编码约定
- [约定1]
- [约定2]
```

---

## Layer 3: _AI_CONTEXT.md 模板

### 职责说明

为**每个重要模块**提供详细文档，**与代码放在同一目录**：
- 职责边界（做什么、不做什么）
- 内部结构（文件组织）
- 对外接口（关键函数/类）
- 依赖关系（依赖谁、被谁依赖）

### 命名规范

- **文件名**: `_AI_CONTEXT.md`（下划线前缀，排在目录最前）
- **位置**: 与代码文件同级目录

### 创建标准

| 情况 | 是否创建 |
|------|---------|
| 核心业务模块 | ✅ 是 |
| 被多个模块依赖的基础模块 | ✅ 是 |
| 复杂度较高的模块 | ✅ 是 |
| 简单的配置目录 | ❌ 否 |
| 纯静态资源目录 | ❌ 否 |

### 完整模板

```markdown
# Module: /当前目录路径

## 职责范围

**核心职责**:
- [职责1]
- [职责2]
- [职责3]

**不负责**:
- [非职责1] - 由 /其他目录 负责
- [非职责2] - 由 /其他目录 负责

```
---

## 文件结构

```
/当前目录/
├── _AI_CONTEXT.md    - 本文档
├── file1.py          - [作用描述]
├── file2.py          - [作用描述]
└── subdir/
    └── file3.py      - [作用描述]
```

---

## 关键接口

### function_or_class_1
- **用途**: [做什么]
- **签名**: `function(arg1: type, arg2: type) -> return_type`
- **位置**: file.py:行号
- **示例**:
  ```python
  result = function(arg1, arg2)
  ```

---

## 依赖关系

**依赖的模块**:
- `/模块A` - 使用其 [功能]
- `/模块B` - 使用其 [功能]

**被依赖的模块**:
- `/模块C` - 调用本模块的 [接口]

---

## 注意事项

### 常见陷阱
- [陷阱1]
- [陷阱2]

### 扩展指南
1. [步骤1]
2. [步骤2]

---

## 文档层级阅读顺序

```
新 AI 对话开始
    ↓
阅读 _RULES.md（了解行为规范）
    ↓
阅读 MAP.md（建立项目全局视图）
    ↓
根据任务定位目标模块
    ↓
阅读目标模块的 _AI_CONTEXT.md
    ↓
按需阅读具体代码文件
```

---

## 下一步

- [003-自动化工具配置.md](./003-自动化工具配置.md) - 了解配置文件规范
- [004-初始化流程说明.md](./004-初始化流程说明.md) - 学习如何初始化框架
